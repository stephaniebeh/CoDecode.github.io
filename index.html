<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        box-sizing: border-box;
      }

      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #ffffff;
        font-size: 15px;
        font-family: Rubik, Helvetica, sans-serif;
        font-weight: 500;
      }

      #top-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 50px;
        background-color: white;
        z-index: 5;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 10px;
        box-sizing: border-box;
      }

      #left-buttons {
        display: flex;
        justify-content: flex-start;
        align-items: center;
      }

      #right-buttons {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 10px;
      }

      #view-log, #slit-scanner-btn, #magic-lens-btn, #home-btn {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        margin: 0.2rem;
        font-family: Rubik, Helvetica, sans-serif;
/*         background-color: #2196F3; */
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        z-index: 10;
        flex-shrink: 0;
      }

/*       #view-log:hover, #slit-scanner-btn:hover, #magic-lens-btn:hover, #home-btn:hover {
        background-color: #1e87db;
      } */

      #right-buttons:has(#slit-scanner-btn[style*="display: none"]) #magic-lens-btn {
        margin: 0 auto;
      }

      #qr-reader {
        width: 100vw;
        max-width: 100%;
        height: auto;
        max-height: calc(100vh - 50px);
        margin: 0 auto;
        box-sizing: border-box;
      }

      #qr-result {
        display: none;
        width: 90%;
        max-width: 600px;
        padding: 10px;
        text-align: center;
        font-size: 16px;
        font-family: Rubik, Helvetica, sans-serif;
        background-color: #f0f0f0;
        border-radius: 5px;
        overflow-wrap: break-word;
        z-index: 10;
        position: absolute;
        bottom: 210px;
        left: 50%;
        transform: translateX(-50%);
        color: #000000;
      }

      #qr-result a {
        color: #0066cc;
        text-decoration: underline;
        cursor: pointer;
      }

      #qr-result a:hover {
        color: #003366;
      }

      #hint-box {
        display: none;
        width: 90%;
        max-width: 600px;
        padding: 10px;
        text-align: center;
        font-size: 16px;
        font-family: Rubik, Helvetica, sans-serif;
        background-color: #e0f7fa;
        border-radius: 5px;
        word-break: break-all;
        z-index: 10;
        position: absolute;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        color: #000000;
        animation: fadeInOut 5s ease-in-out;
      }

      @keyframes fadeInOut {
        0% { opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { opacity: 0; }
      }

      #qr-log {
      display: none;
      width: 95vw;
      max-width: 600px;
      max-height: 80vh;  /* âœ… FIXED: Use fixed height instead of max-height */
      padding: 20px;
      background-color: #ffffff;
      border: 1px solid #ccc;
      border-radius: 12px;
      z-index: 20;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      overflow-y: auto;  /* âœ… FIXED: Enable vertical scrolling */
      overflow-x: hidden; /* âœ… Keep no horizontal scrolling */
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      font-family: Rubik, sans-serif;
      backdrop-filter: none !important;      /* âœ… PREVENT BLUR ON LOG */
      -webkit-backdrop-filter: none !important; /* âœ… Safari fix */
    }

      #qr-log h2 {
        margin: 0 0 10px;
        font-size: 18px;
        text-align: center;
      }

      #qr-log ul {
        list-style: none;
        padding: 0;
        margin: 0 0 10px;
        flex-grow: 1;
      }

      #qr-log li {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        margin-bottom: 5px;
        background-color: #f9f9f9;
        border-radius: 3px;
        font-size: 14px;
      }
      
      #qr-log-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5); 
      z-index: 15;                           
      backdrop-filter: blur(4px);
    }

      .log-text {
        flex: 1;
        min-width: 0; /* ðŸ”¥ CRITICAL: Allows flex shrinking */
        word-break: break-word;
        overflow-wrap: break-word;
        white-space: normal;
        line-height: 1.4;
        color: #333;
        margin-right: 5px
      }

      .log-text a {
        color: #0066cc;
        text-decoration: underline;
        cursor: pointer;
      }

      .log-text a:hover {
        color: #003366;
      }

      .reorder-btn {
        padding: 5px;
        font-size: 12px;
        margin: 3px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
/*         background-color: #2196F3; */
        color: white;
        min-width: 24px; 
        height: 24px; 
        text-align: center;   
        vertical-align: middle;
        line-height: 14px;
      }

      .reorder-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .delete-btn {
        padding: 5px;
        font-size: 12px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        background: #f44336;
        color: white;
        min-width: 50px;
        height: 24px; 
        text-align: center;   
        vertical-align: middle; 

        margin: 3px
      }

      #qr-log .button-container {
        display: flex;
        justify-content: center; /* Center the clear button */
        margin-top: 10px;
      }

      #clear-log {
        padding: 8px 16px;
        font-size: 14px;
        font-family: Rubik, Helvetica, sans-serif;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      #clear-log:hover {
        background-color: #da190b;
      }

        #close-log {
        position: absolute;
        top: 0px;
        right: 0px;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 50%;
        width: 10px;     /* âœ… CHANGE THIS */
        height: 10px ;    /* âœ… CHANGE THIS */
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        font-family: Rubik, Helvetica, sans-serif;
      }

      #lock-popup-close{
        position: absolute;
        top: 0px;
        right: 0px;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 50%;
        width: 10px;   
        height: 10px ;  
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        font-family: Rubik, Helvetica, sans-serif;
      }
      
      
      #close-log:hover {
        background-color: #da190b;
      }

      #slit-scanner-page, #rgb-filter-page, #lock-page {
        width: 100%;
        height: 100vh;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #000000;
        overflow: hidden;
        position: relative;
      }

      #slit-scanner-canvas, #rgb-filter-canvas, #lock-canvas {
        display: block;
        width: 100vw;
        max-width: 100%;
        height: calc(100vh - 50px);
        object-fit: cover;
        position: absolute;
        top: 50px;
        left: 0;
      }
      
      #rgb-filter-page {
  width: 100%;
  height: 100vh;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background-color: #000000;
  overflow: hidden;
  position: relative;
  padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); /* Respect safe areas */
}

#rgb-filter-canvas {
  display: block;
  width: 100vw;
  max-width: 100%;
  height: calc(100vh - 50px - env(safe-area-inset-top) - env(safe-area-inset-bottom)); /* Adjust for top bar and safe areas */
  object-fit: cover;
  position: absolute;
  top: calc(50px + env(safe-area-inset-top)); /* Account for top bar and safe area */
  left: 50%;
  transform: translateX(-50%); /* Center horizontally */
}

#rgb-button-container {
  position: absolute;
  bottom: 70px; /* Matches previous buttonY offset */
  width: 100%;
  display: flex;
  justify-content: center; /* Center buttons horizontally */
  gap: 10px; /* Matches buttonSpacing */
  z-index: 10; /* Ensure buttons are above canvas */
  padding: 0 10px; /* Prevent buttons from touching screen edges */
  box-sizing: border-box;
}

/* Style for p5.js-generated buttons */
.rgb-button-container button {
  width: 50px; /* Matches buttonSize */
  height: 50px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  flex-shrink: 0; /* Prevent buttons from shrinking */
}

      #image-popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 30;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #image-popup img {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        touch-action: pinch-zoom;
      }

      #image-popup-close {
        position: absolute;
        top: 60px;
        right: 10px;
        background-color: #f44336;
        color: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        font-size: 18px;
        font-family: Rubik, Helvetica, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        cursor: pointer;
        z-index: 31;
        transition: background-color 0.3s ease;
      }

      #image-popup-close:hover {
        background-color: #da190b;
      }

      #confetti-popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 35;
        display: flex;
        justify-content: center;
        align-items: center;
        pointer-events: none;
      }

      #confetti-popup img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        opacity: 0.9;
      }

      #lock-popup {
      display: none;
      position: fixed;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      max-width: none !important;
      max-height: none !important;
      transform: none !important;
      background-color: #ffffff;
      border: none !important;
      border-radius: 0 !important;
      z-index: 100;
      box-shadow: none !important;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 !important;
      backdrop-filter: none !important;
    }

      #lock-canvas-container {
        width: 100%;
        height: auto;
        display: flex;
        justify-content: center;
      }

      #lock-popup .button-container {
        display: flex;
        justify-content: center;
        margin-top: 10px;
      }

      #lock-cancel {
        padding: 8px 16px;
        font-size: 14px;
        font-family: Rubik, Helvetica, sans-serif;
        background-color: white ;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      #lock-cancel:hover {
        background-color: white ;
      }

      #lock-popup-close{
      position: fixed !important;  /* âœ… FIXED: Use fixed instead of absolute */
      top: 0px !important;
      right: 0px !important;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px !important;     /* âœ… BIGGER & VISIBLE */
      height: 20px !important;    /* âœ… BIGGER & VISIBLE */
      font-size: 20px !important;
      font-weight: bold;
      cursor: pointer;
      display: flex !important;
      align-items: center;
      justify-content: center;
      z-index: 101 !important;
      font-family: Rubik, Helvetica, sans-serif;
    }

      #lock-popup-close:hover {
        background-color: #da190b;
      }

      #html5-qrcode-anchor-scan-type-change {
        display: none !important;
      }

      button {
        background: none;
        border: none;
        padding: 1rem;
        margin: 1rem;
        font-size: 1rem;
        font-family: Rubik, Helvetica, sans-serif;
        border-radius: 0.5rem;
        background: black;
        color: white;
        text-align: center;
      }

      button#qr-result {
        font-weight: 200;
      }

      button#slit-scanner-btn {
        background: linear-gradient(70deg, black 0%, white 100%);
      }

      button#html5-qrcode-button-torch {
        background: #404040;
        color: white;
      }

      #qr-reader__dashboard {
        position: fixed;
        box-sizing: border-box;
        bottom: 0;
        left: 0;
        margin: 1rem;
        width: calc(100vw - 2rem) !important;
        background: #EEE;
        border-radius: 1rem;
        height: 10rem;
        padding: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }

      #qr-reader__dashboard .button {
        display: flex;
        flex-direction: row;
        gap: 0.5rem;
        justify-content: center;
        align-items: center;
        width: 100%;
        max-width: 600px;
      }

      #html5-qrcode-button-camera-stop, #html5-qrcode-button-torch {
        flex: 1;
        max-width: 45%;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        font-family: Rubik, sans-serif;
        background: red;
        color: white;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        text-align: center;
        box-sizing: border-box;
/*         font-weight: bold; */
      }

      #html5-qrcode-button-torch {
        background: black;
      }
    
      #magic-lens-btn{
      background: linear-gradient(70deg, black 0%, white 100%);
      }
      
      #html5-qrcode-button-camera-start{
      background: linear-gradient(70deg, black 50%, white 100%);

      }

      #html5-qrcode-button-camera-stop:hover, #html5-qrcode-button-torch:hover {
        opacity: 0.9;
      }

      img[src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzNzEuNjQzIDM3MS42NDMiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDM3MS42NDMgMzcxLjY0MyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBhdGggZD0iTTEwNS4wODQgMzguMjcxaDE2My43Njh2MjBIMTA1LjA4NHoiLz48cGF0aCBkPSJNMzExLjU5NiAxOTAuMTg5Yy03LjQ0MS05LjM0Ny0xOC40MDMtMTYuMjA2LTMyLjc0My0yMC41MjJWMzBjMC0xNi41NDItMTMuNDU4LTMwLTMwLTMwSDEyNS4wODRjLTE2LjU0MiAwLTMwIDEzLjQ1OC0zMCAzMHYxMjAuMTQzaC04LjI5NmMtMTYuNTQyIDAtMzAgMTMuNDU4LTMwIDMwdjEuMzMzYTI5LjgwNCAyOS44MDQgMCAwIDAgNC42MDMgMTUuOTM5Yy03LjM0IDUuNDc0LTEyLjEwMyAxNC4yMjEtMTIuMTAzIDI0LjA2MXYxLjMzM2MwIDkuODQgNC43NjMgMTguNTg3IDEyLjEwMyAyNC4wNjJhMjkuODEgMjkuODEgMCAwIDAtNC42MDMgMTUuOTM4djEuMzMzYzAgMTYuNTQyIDEzLjQ1OCAzMCAzMCAzMGg4LjMyNGMuNDI3IDExLjYzMSA3LjUwMyAyMS41ODcgMTcuNTM0IDI2LjE3Ny45MzEgMTAuNTAzIDQuMDg0IDMwLjE4NyAxNC43NjggNDUuNTM3YTkuOTg4IDkuOTg4IDAgMCAwIDguMjE2IDQuMjg4IDkuOTU4IDkuOTU4IDAgMCAwIDUuNzA0LTEuNzkzYzQuNTMzLTMuMTU1IDUuNjUtOS4zODggMi40OTUtMTMuOTIxLTYuNzk4LTkuNzY3LTkuNjAyLTIyLjYwOC0xMC43Ni0zMS40aDgyLjY4NWMuMjcyLjQxNC41NDUuODE4LjgxNSAxLjIxIDMuMTQyIDQuNTQxIDkuMzcyIDUuNjc5IDEzLjkxMyAyLjUzNCA0LjU0Mi0zLjE0MiA1LjY3Ny05LjM3MSAyLjUzNS0xMy45MTMtMTEuOTE5LTE3LjIyOS04Ljc4Ny0zNS44ODQgOS41ODEtNTcuMDEyIDMuMDY3LTIuNjUyIDEyLjMwNy0xMS43MzIgMTEuMjE3LTI0LjAzMy0uODI4LTkuMzQzLTcuMTA5LTE3LjE5NC0xOC42NjktMjMuMzM3YTkuODU3IDkuODU3IDAgMCAwLTEuMDYxLS40ODZjLS40NjYtLjE4Mi0xMS40MDMtNC41NzktOS43NDEtMTUuNzA2IDEuMDA3LTYuNzM3IDE0Ljc2OC04LjI3MyAyMy43NjYtNy42NjYgMjMuMTU2IDEuNTY5IDM5LjY5OCA3LjgwMyA0Ny44MzYgMTguMDI2IDUuNzUyIDcuMjI1IDcuNjA3IDE2LjYyMyA1LjY3MyAyOC43MzMtLjQxMyAyLjU4NS0uODI0IDUuMjQxLTEuMjQ1IDcuOTU5LTUuNzU2IDM3LjE5NC0xMi45MTkgODMuNDgzLTQ5Ljg3IDExNC42NjEtNC4yMjEgMy41NjEtNC43NTYgOS44Ny0xLjE5NCAxNC4wOTJhOS45OCA5Ljk4IDAgMCAwIDcuNjQ4IDMuNTUxIDkuOTU1IDkuOTU1IDAgMCAwIDYuNDQ0LTIuMzU4YzQyLjY3Mi0zNi4wMDUgNTAuODAyLTg4LjUzMyA1Ni43MzctMTI2Ljg4OC40MTUtMi42ODQuODIxLTUuMzA5IDEuMjI5LTcuODYzIDIuODM0LTE3LjcyMS0uNDU1LTMyLjY0MS05Ljc3Mi00NC4zNDV6bS0yMzIuMzA4IDQyLjYyYy01LjUxNCAwLTEwLTQuNDg2LTEwLTEwdi0xLjMzM2MwLTUuNTE0IDQuNDg2LTEwIDEwLTEwaDE1djIxLjMzM2gtMTV6bS0yLjUtNTIuNjY2YzAtNS41MTQgNC40ODYtMTAgMTAtMTBoNy41djIxLjMzM2gtNy41Yy01LjUxNCAwLTEwLTQuNDg2LTEwLTEwdi0xLjMzM3ptMTcuNSA5My45OTloLTcuNWMtNS41MTQgMC0xMC00LjQ4Ni0xMC0xMHYtMS4zMzNjMC01LjUxNCA0LjQ4Ni0xMCAxMC0xMGg3LjV2MjEuMzMzem0zMC43OTYgMjguODg3Yy01LjUxNCAwLTEwLTQuNDg2LTEwLTEwdi04LjI3MWg5MS40NTdjLS44NTEgNi42NjgtLjQzNyAxMi43ODcuNzMxIDE4LjI3MWgtODIuMTg4em03OS40ODItMTEzLjY5OGMtMy4xMjQgMjAuOTA2IDEyLjQyNyAzMy4xODQgMjEuNjI1IDM3LjA0IDUuNDQxIDIuOTY4IDcuNTUxIDUuNjQ3IDcuNzAxIDcuMTg4LjIxIDIuMTUtMi41NTMgNS42ODQtNC40NzcgNy4yNTEtLjQ4Mi4zNzgtLjkyOS44LTEuMzM1IDEuMjYxLTYuOTg3IDcuOTM2LTExLjk4MiAxNS41Mi0xNS40MzIgMjIuNjg4aC05Ny41NjRWMzBjMC01LjUxNCA0LjQ4Ni0xMCAxMC0xMGgxMjMuNzY5YzUuNTE0IDAgMTAgNC40ODYgMTAgMTB2MTM1LjU3OWMtMy4wMzItLjM4MS02LjE1LS42OTQtOS4zODktLjkxNC0yNS4xNTktMS42OTQtNDIuMzcgNy43NDgtNDQuODk4IDI0LjY2NnoiLz48cGF0aCBkPSJNMTc5LjEyOSA4My4xNjdoLTI0LjA2YTUgNSAwIDAgMC01IDV2MjQuMDYxYTUgNSAwIDAgMCA1IDVoMjQuMDZhNSA1IDAgMCAwIDUtNVY4OC4xNjdhNSA1IDAgMCAwLTUtNXpNMTcyLjYyOSAxNDIuODZoLTEyLjU2VjEzMC44YTUgNSAwIDEgMC0xMCAwdjE3LjA2MWE1IDUgMCAwIDAgNSA1aDE3LjU2YTUgNSAwIDEgMCAwLTEwLjAwMXpNMjE2LjU2OCA4My4xNjdoLTI0LjA2YTUgNSAwIDAgMC01IDV2MjQuMDYxYTUgNSAwIDAgMCA1IDVoMjQuMDZhNSA1IDAgMCAwIDUtNVY4OC4xNjdhNSA1IDAgMCAwLTUtNXptLTUgMjQuMDYxaC0xNC4wNlY5My4xNjdoMTQuMDZ2MTQuMDYxek0yMTEuNjY5IDEyNS45MzZIMTk3LjQxYTUgNSAwIDAgMC01IDV2MTQuMjU3YTUgNSAwIDAgMCA1IDVoMTQuMjU5YTUgNSAwIDAgMCA1LTV2LTE0LjI1N2E1IDUgMCAwIDAtNS01eiIvPjwvc3ZnPg=="] {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="top-bar">
      <div id="left-buttons">
        <button id="view-log" style="display: none;">View Log</button>
        <button id="home-btn" style="display: none;">Home</button>
      </div>
      <div id="right-buttons">
        <button id="magic-lens-btn" style="display: none;">Magic Lens</button>
        <button id="slit-scanner-btn" style="display: none;">
          Slit Scanner
        </button>
      </div>
    </div>
    <div id="qr-reader"></div>
    <div id="qr-result" class="qr-result"></div>
    <div id="hint-box" class="hint-box"></div>
    <div id="qr-log" class="qr-log" style="display: none;">
      <h2>Code Log</h2>
      <ul id="log-list"></ul>
      <div class="button-container">
        <button id="clear-log">Clear Log</button>
      </div>
      <button id="close-log">x</button>
    </div>
    <div id="qr-log-backdrop" style="display: none;"></div>
    <div id="image-popup" style="display: none;">
      <img id="popup-image" src="" alt="QR Image" />
      <button id="image-popup-close">x</button>
    </div>
    <div id="confetti-popup" style="display: none;">
      <img id="confetti-image" src="" alt="Confetti" />
    </div>
    <div id="slit-scanner-page">
      <div id="slit-scanner-canvas"></div>
    </div>
    <div id="rgb-filter-page">
      <div id="rgb-filter-canvas"></div>
      <div id="rgb-button-container" class="rgb-button-container"></div>
    </div>
    <div id="lock-page">
      <div id="lock-canvas"></div>
    </div>
    <div id="lock-popup" style="display: none;">
      <button id="lock-popup-close">x</button>
      <div id="lock-canvas-container"></div>
    </div>
    <script>
      // Your existing JavaScript code remains unchanged
      const config = {
        fps: 10,
        qrbox: Math.min(window.innerWidth * 0.8, 250),
        showTorchButtonIfSupported: true,
        rememberLastUsedCamera: true,
      };

      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM loaded, initializing app");

        // Clear localStorage to reset game state
        localStorage.removeItem("qrLog");
        localStorage.removeItem("unlockedTools");
        console.log("localStorage cleared for qrLog and unlockedTools");

        const resultDiv = document.getElementById("qr-result");
        const hintBox = document.getElementById("hint-box");
        const viewLogButton = document.getElementById("view-log");
        const logDiv = document.getElementById("qr-log");
        const logList = document.getElementById("log-list");
        const closeLogButton = document.getElementById("close-log");
        const clearLogButton = document.getElementById("clear-log");
        const slitScannerButton = document.getElementById("slit-scanner-btn");
        const magicLensButton = document.getElementById("magic-lens-btn");
        const homeButton = document.getElementById("home-btn");
        const qrReader = document.getElementById("qr-reader");
        const slitScannerPage = document.getElementById("slit-scanner-page");
        const rgbFilterPage = document.getElementById("rgb-filter-page");
        const lockPage = document.getElementById("lock-page");
        const imagePopup = document.getElementById("image-popup");
        const popupImage = document.getElementById("popup-image");
        const imagePopupClose = document.getElementById("image-popup-close");
        const confettiPopup = document.getElementById("confetti-popup");
        const confettiImage = document.getElementById("confetti-image");
        const lockPopup = document.getElementById("lock-popup");
        const lockPopupClose = document.getElementById("lock-popup-close");

        if (!resultDiv || !hintBox || !viewLogButton || !logDiv || !logList ||
            !closeLogButton || !clearLogButton || !slitScannerButton || !magicLensButton ||
            !homeButton || !qrReader || !slitScannerPage || !rgbFilterPage || !lockPage ||
            !imagePopup || !popupImage || !imagePopupClose || !confettiPopup || !confettiImage ||
            !lockPopup || !lockPopupClose) {
          console.error("Error: Missing DOM elements");
          return;
        }

        let clearTextTimer = null;
        let unlockedRoom = 1;
        let qrLog = [];
        let lastScanText = null;
        let isProcessingScan = false;
        let currentView = "scanner";
        let html5QrcodeScanner = null;
        let slitScannerInstance = null;
        let rgbFilterInstance = null;
        let lockInstance = null;
        let unlockedTools = { "Slit Scanner": false, "Magic Lens": false };
        let selectedCameraId = null;
        let isShowingOpenLock = false;
        let lastTapTime = 0;
        const tapDebounceDelay = 200;
        let currentHint = "Scan the big QR code by the entrance";

        // Initialize button visibility
        viewLogButton.style.display = "none";
        slitScannerButton.style.display = "none";
        magicLensButton.style.display = "none";
        console.log("Initial state: qrLog=", qrLog, "unlockedTools=", unlockedTools, "currentHint=", currentHint);

        // Initialize torch button state
        function initializeTorchButton() {
          const torchButton = document.getElementById("html5-qrcode-button-torch");
          if (torchButton) {
            torchButton.classList.remove("html5-qrcode-element-button-torch-on");
            console.log("Torch button initialized to off state");
          }
        }

        // QR code mappings
        const qrMappings = {
          "Drawers keep secrets": {
            fullText: "1: Drawers keep secrets",
            text: "Drawers keep secrets",
            hint: "Barcodes require an uninterrupted line of code"
          },
          "6": {
            fullText: "1: 6",
            text: "Where are we?",
            hint: "Find the directory"
          },
          "Vinyl": {
            fullText: "1: Vinyl",
            text: "Vinyl",
            linkText: "Vinyl",
            image: "img/vinyl.png",
            hint: "Scan the vinyl"
          },
          "1234": {
            fullText: "1: 1234",
            text: "New Room Unlocked! Unfold ONCE to enter room and find the vinyl",
            room: true,
            hint: "Scan the correct vinyl poster"
          },
          "22": {
            fullText: "2: 22",
            text: "New Tool Unlocked!: Slit Scanner",
            linkText: "New Tool Unlocked!: Slit Scanner",
            tool: "Slit Scanner",
            hint: "Watch your step, work with your tools and friends"
          },
          "Bk": {
            fullText: "2: Bk",
            text: "Book",
            linkText: "Book",
            image: "img/book.png",
            hint: "Pull out those books"
          },
          "Wall": {
            fullText: "2: Wall",
            text: "Wall",
            linkText: "Wall",
            image: "img/wall.png",
            hint: "Scan the wall"
          },
          "R": {
            fullText: "2: R",
            text: "New Tool Unlocked!: Magic Lens",
            linkText: "Magic Lens",
            tool: "Magic Lens",
            hint: "See red, there are layers in the floor"
          },
          "1234_2": {
            fullText: "2: 1234",
            text: "New Room Unlocked! Unfold to see the whole poster",
            room: true,
            hint: "Follow the footsteps"
          },
          "33": {
            fullText: "3: 33",
            text: "Find Me",
            linkText: "Find Me",
            image: "img/person.png",
            hint: "Follow the gaze of this person"
          },
          "31061602170": {
            fullText: "3: 31061602170",
            text: "31061602170",
            hint: "Return to room 1 and scan the lock QR code"
          },
          "Lock": {
            fullText: "1: Lock",
            text: "Lock",
            action: "showLock",
            hint: "A long string on the floor"
          },
          "Hint": {
            fullText: "Hint",
            text: "",
            action: "showHint",
            hint: qrLog.length === 0 ? "Where's Waldo?" : currentHint
          },
          "RR": {
            fullText: "2: RR",
            text: "Click me!",
            linkText: "Click me!",
            url: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
            hint: currentHint
          }
        };

        // Parse QR text
        function parseQRText(text) {
          console.log(`Parsing QR text: '${text}'`);
          const match = text.match(/^(\d+): *(.*)$/);
          let room = match ? parseInt(match[1]) : 1;
          let content = match ? match[2] : text;
          content = content.replace(/#[0-9]+/, '').trim();
          if (content === "1234" && room === 2) {
            content = "1234_2";
          }
          console.log(`Parsed: room=${room}, content='${content}'`);
          return { room, content };
        }

        // Format text for display
        function formatText(fullText, content, forLog = false) {
          if (qrMappings.hasOwnProperty(content)) {
            const mapping = qrMappings[content];
            const displayText = forLog ? mapping.fullText : mapping.text;
            if (mapping.room) {
              return mapping.text;
            }
            if (mapping.url) {
              return displayText.replace(
                mapping.linkText,
                `<a href="${mapping.url}" target="_blank" rel="noopener noreferrer">${mapping.linkText}</a>`
              );
            }
            if (mapping.image && forLog) {
              return displayText.replace(
                mapping.linkText,
                `<a href="#" class="image-link" data-image="${mapping.image}">${mapping.linkText}</a>`
              );
            }
            return mapping.text;
          }
          const displayText = forLog ? fullText : content;
          return displayText.replace(/\b(https?:\/\/[^\s]+|www\.[^\s]+)/gi, function(url) {
            const href = url.match(/^https?:\/\//) ? url : `https://${url}`;
            return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
          });
        }

        // Show hint box
        function showHintBox(hintText) {
          console.log(`Showing hint: ${hintText}`);
          hintBox.innerHTML = hintText;
          hintBox.style.display = "block";
          hintBox.offsetHeight;
          setTimeout(() => {
            hintBox.style.display = "none";
            console.log("Hint box hidden");
          }, 5000);
        }

        // Show image pop-up
        function showImagePopup(imageSrc, isOpenLock = false) {
          console.log(`Showing image pop-up: ${imageSrc}, isOpenLock=${isOpenLock}`);
          popupImage.src = imageSrc;
          imagePopup.style.display = "flex";
          imagePopup.offsetHeight;
          isShowingOpenLock = isOpenLock;
          if (imageSrc.includes("openlock.png") || imageSrc.includes("openlockcloseup.png")) {
            imagePopupClose.style.display = "none";
            console.log("Hiding close button for", imageSrc);
          } else {
            imagePopupClose.style.display = "block";
            console.log("Showing close button for", imageSrc);
          }
          console.log("Image pop-up displayed, style.display:", imagePopup.style.display, "image src:", popupImage.src);
        }

        // Show confetti pop-up
        function showConfettiPopup() {
          console.log("Showing confetti pop-up: img/confetti.gif");
          confettiImage.src = "img/confetti.gif";
          confettiPopup.style.display = "flex";
          confettiPopup.offsetHeight;
          console.log("Confetti pop-up displayed, style.display:", confettiPopup.style.display);
          setTimeout(() => {
            console.log("Hiding confetti pop-up after 3 seconds");
            confettiPopup.style.display = "none";
            confettiImage.src = "";
            console.log("Confetti pop-up hidden, style.display:", confettiPopup.style.display);
          }, 3000);
        }

        // Close image and confetti pop-ups
        function closeImageAndConfettiPopups() {
          console.log("Closing image and confetti pop-ups");
          imagePopup.style.display = "none";
          confettiPopup.style.display = "none";
          popupImage.src = "";
          confettiImage.src = "";
          imagePopupClose.style.display = "none";
          isShowingOpenLock = false;
          isProcessingScan = false;
          lastScanText = null;
          switchView("scanner");
        }

        // Handle lock image tap
        function handleLockImageTap(e) {
          const currentTime = Date.now();
          if (currentTime - lastTapTime < tapDebounceDelay) {
            console.log("Debouncing: Ignoring rapid tap on lock image");
            return;
          }
          lastTapTime = currentTime;
          console.log("Lock image tapped, isShowingOpenLock:", isShowingOpenLock, "current image:", popupImage.src);
          if (isShowingOpenLock && popupImage.src.includes("openlock.png")) {
            console.log("Switching from openlock.png to openlockcloseup.png");
            imagePopup.style.display = "none";
            popupImage.src = "";
            showImagePopup("img/openlockcloseup.png", false);
            showConfettiPopup();
            isShowingOpenLock = false;
          } else if (popupImage.src.includes("openlockcloseup.png")) {
            console.log("Closing openlockcloseup.png and returning to scanner");
            closeImageAndConfettiPopups();
          }
        }

        popupImage.addEventListener("click", handleLockImageTap);
        popupImage.addEventListener("touchstart", handleLockImageTap);

        imagePopupClose.addEventListener("click", () => {
          console.log("Image pop-up close button clicked");
          closeImageAndConfettiPopups();
        });

        function stopQRScannerStream() {
          if (html5QrcodeScanner) {
            try {
              console.log("Stopping QR scanner stream");
              const videoElement = qrReader.querySelector('video');
              if (videoElement && videoElement.srcObject) {
                const stream = videoElement.srcObject;
                const tracks = stream.getTracks();
                tracks.forEach(track => {
                  track.stop();
                  console.log("QR scanner video track stopped:", track.label);
                });
                videoElement.srcObject = null;
              }
              html5QrcodeScanner.clear();
              html5QrcodeScanner = null;
              console.log("QR scanner cleared");
            } catch (err) {
              console.error("Error stopping QR scanner stream:", err);
            }
          }
        }

        function cleanUpCanvases() {
          console.log("Cleaning up canvases");
          const slitCanvas = slitScannerPage.querySelector('canvas');
          const rgbCanvas = rgbFilterPage.querySelector('canvas');
          const lockCanvas = lockPage.querySelector('canvas');
          const lockPopupCanvas = lockPopup.querySelector('canvas');
          const lockCanvasContainer = document.getElementById('lock-canvas-container');

          if (slitCanvas) {
            slitCanvas.remove();
            console.log("Slit Scanner canvas removed");
          }
          if (rgbCanvas) {
            rgbCanvas.remove();
            console.log("RGB Filter canvas removed");
          }
          if (lockCanvas) {
            lockCanvas.remove();
            console.log("Lock canvas removed");
          }
          if (lockPopupCanvas) {
            lockPopupCanvas.remove();
            console.log("Lock pop-up canvas removed");
          }
          // Clear all content in lock-canvas-container
          if (lockCanvasContainer) {
            lockCanvasContainer.innerHTML = '';
            console.log("Lock canvas container cleared");
          }
        }

        // âœ… FIXED switchView function
        function switchView(view) {
          if (currentView === view) {
            console.log(`Already in view: ${view}`);
            return;
          }
          console.log(`Switching to view: ${view}`);

          if (currentView === "scanner") {
            stopQRScannerStream();
          } else if (currentView === "slit-scanner" && slitScannerInstance) {
            console.log("Removing Slit Scanner instance");
            try {
              slitScannerInstance.noLoop();
              slitScannerInstance.remove();
              slitScannerInstance = null;
              console.log("Slit Scanner instance removed");
            } catch (err) {
              console.error("Error removing Slit Scanner:", err);
            }
          } else if (currentView === "rgb-filter" && rgbFilterInstance) {
            console.log("Removing RGB Filter instance");
            try {
              rgbFilterInstance.noLoop();
              rgbFilterInstance.remove();
              rgbFilterInstance = null;
              console.log("RGB Filter instance removed");
            } catch (err) {
              console.error("Error removing RGB Filter:", err);
            }
          } else if (currentView === "lock" && lockInstance) {
            console.log("Removing Lock instance");
            try {
              lockInstance.noLoop();
              lockInstance.remove();
              lockInstance = null;
              console.log("Lock instance removed");
            } catch (err) {
              console.error("Error removing Lock:", err);
            }
          }

          cleanUpCanvases();

          currentView = view;

          qrReader.style.display = view === "scanner" ? "block" : "none";
          resultDiv.style.display = view === "scanner" ? "block" : "none";
          resultDiv.innerHTML = "";  // âœ… FIX: Clear any leftover text
          slitScannerPage.style.display = view === "slit-scanner" ? "flex" : "none";
          rgbFilterPage.style.display = view === "rgb-filter" ? "flex" : "none";
          lockPage.style.display = view === "lock" ? "flex" : "none";
          homeButton.style.display = view === "scanner" ? "none" : "block";
          viewLogButton.style.display = view === "scanner" && qrLog.length > 0 ? "block" : "none";
          slitScannerButton.style.display = view === "scanner" && unlockedTools["Slit Scanner"] ? "block" : "none";
          magicLensButton.style.display = view === "scanner" && unlockedTools["Magic Lens"] ? "block" : "none";

          console.log(`DOM state: qrReader=${qrReader.style.display}, slitScannerPage=${slitScannerPage.style.display}, rgbFilterPage=${rgbFilterPage.style.display}, lockPage=${lockPage.style.display}, homeButton=${homeButton.style.display}`);

          if (view === "scanner") {
            console.log("Initializing QR scanner");
            setTimeout(() => {
              try {
                html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", config);
                html5QrcodeScanner.render(onScanSuccess, onScanError, (cameraId) => {
                  selectedCameraId = cameraId;
                  console.log("Selected camera ID:", selectedCameraId);
                  initializeTorchButton();
                });
                console.log("QR scanner initialized");
              } catch (err) {
                console.error("Error initializing QR scanner:", err);
                resultDiv.style.display = "block";
                resultDiv.innerHTML = "Error: Unable to start QR scanner. Please check camera permissions or refresh.";
              }
            }, 200);
          } else if (view === "slit-scanner") {
            console.log("Initializing Slit Scanner");
            slitScannerInstance = new p5(slitScannerSketch, "slit-scanner-canvas");
          } else if (view === "rgb-filter") {
            console.log("Initializing RGB Filter");
            rgbFilterInstance = new p5(rgbFilterSketch, "rgb-filter-canvas");
          } else if (view === "lock") {
            console.log("Initializing Lock");
            lockInstance = new p5(lockSketch, "lock-canvas");
          }
        }

        function storeQRCode(fullText) {
          qrLog = JSON.parse(localStorage.getItem("qrLog") || "[]");
          qrLog.push({ text: fullText });
          localStorage.setItem("qrLog", JSON.stringify(qrLog));
          console.log("Stored QR:", fullText, "New qrLog:", qrLog);
          viewLogButton.style.display = "block";
        }
        function showLockPopup() {
          console.log("Attempting to show lock pop-up");
          lockPopup.style.display = "flex";
          lockPopup.offsetHeight; // Force reflow
          console.log("Lock pop-up display set to flex, style.display:", lockPopup.style.display);

          // Clear previous lock instance and canvas
          if (lockInstance) {
            try {
              lockInstance.noLoop();
              lockInstance.remove();
              lockInstance = null;
              console.log("Existing lock instance removed");
            } catch (err) {
              console.error("Error removing lock instance:", err);
            }
          }

          // Clear lock-canvas-container
          const lockCanvasContainer = document.getElementById('lock-canvas-container');
          if (lockCanvasContainer) {
            lockCanvasContainer.innerHTML = '';
            console.log("Lock canvas container cleared before new sketch");
          }

          // Initialize new lock sketch
          console.log("Initializing lock sketch in lock-canvas-container");
          lockInstance = new p5(lockSketch, "lock-canvas-container");
          console.log("Lock sketch initialized");
        }

        function closeLockPopup() {
        console.log("Closing lock pop-up");
        lockPopup.style.display = "none";
        if (lockInstance) {
          try {
            lockInstance.noLoop();
            lockInstance.remove();
            lockInstance = null;
            console.log("Lock instance removed");
          } catch (err) {
            console.error("Error removing Lock instance:", err);
          }
        }
        cleanUpCanvases();
        isProcessingScan = false;
        lastScanText = null;
        switchView("scanner");
      }

        lockPopupClose.addEventListener("click", closeLockPopup);

        function onScanSuccess(decodedText, decodedResult) {
          if (isProcessingScan || decodedText === lastScanText) {
            console.log(`Debouncing: Ignoring scan of '${decodedText}' (isProcessingScan: ${isProcessingScan})`);
            return;
          }
          isProcessingScan = true;
          lastScanText = decodedText;

          console.log(`Code scanned = '${decodedText}'`, decodedResult);
          const parsed = parseQRText(decodedText);
          const { room, content } = parsed;
          console.log(`Parsed: room=${room}, content='${content}', unlockedRoom=${unlockedRoom}`);

          if (clearTextTimer) {
            clearTimeout(clearTextTimer);
            clearTextTimer = null;
          }

          if (content === "Hint") {
            // Special logic: if no QR codes scanned yet, show "Where's Waldo?"
            const hintToShow = qrLog.length === 0 ? "Where's Waldo?" : currentHint;
            console.log(`Hint QR code scanned, qrLog.length=${qrLog.length}, showing hint:`, hintToShow);
            showHintBox(hintToShow);
            isProcessingScan = false;
            lastScanText = null;
            return;
          }

          if (room > unlockedRoom) {
            console.log(`Room ${room} locked, displaying 'To be unlocked'`);
            resultDiv.innerHTML = "To be unlocked";
            resultDiv.style.display = "block";
            clearTextTimer = setTimeout(() => {
              resultDiv.style.display = "none";
              resultDiv.innerHTML = "";
              isProcessingScan = false;
              lastScanText = null;
            }, 10000);
            return;
          }

          if (qrMappings.hasOwnProperty(content)) {
            const mapping = qrMappings[content];
            resultDiv.innerHTML = formatText(decodedText, content);
            resultDiv.style.display = "block";
            storeQRCode(decodedText);
            if (mapping.hint) {
              currentHint = mapping.hint;
              console.log(`Updated currentHint to: ${currentHint}`);
            }

            if (mapping.room && room === unlockedRoom) {
              unlockedRoom = room + 1;
              console.log(`Updated unlockedRoom to ${unlockedRoom}`);
            }

            if (mapping.tool) {
              console.log(`Unlocking tool: ${mapping.tool}`);
              unlockedTools[mapping.tool] = true;
              localStorage.setItem("unlockedTools", JSON.stringify(unlockedTools));
              slitScannerButton.style.display = unlockedTools["Slit Scanner"] ? "block" : "none";
              magicLensButton.style.display = unlockedTools["Magic Lens"] ? "block" : "none";
            }

            if (mapping.action === "showLock") {
              console.log("Lock QR code scanned: triggering lock pop-up");
              showLockPopup();
            } else if (mapping.image) {
              console.log(`Image QR code: displaying image='${mapping.image}'`);
              showImagePopup(mapping.image);
            }

            clearTextTimer = setTimeout(() => {
              resultDiv.style.display = "none";
              resultDiv.innerHTML = "";
              isProcessingScan = false;
              lastScanText = null;
            }, 10000);
            return;
          }

          console.log(`Non-mapped code: displaying content='${content}'`);
          resultDiv.innerHTML = formatText(decodedText, content);
          resultDiv.style.display = "block";
          storeQRCode(decodedText);
          clearTextTimer = setTimeout(() => {
            resultDiv.style.display = "none";
            resultDiv.innerHTML = "";
            isProcessingScan = false;
            lastScanText = null;
          }, 10000);
        }

        function onScanError(error) {
          console.error(`Scan error: ${error}`);
          isProcessingScan = false;
        }

        function populateLog(qrLog) {
        logList.innerHTML = "";
        if (qrLog.length === 0) {
          logList.innerHTML = "<li style='text-align: center; padding: 20px; color: #666;'>No QR codes stored yet.</li>";
          viewLogButton.style.display = "none";
          return;
        }

        qrLog.slice().reverse().forEach((entry, reverseIndex) => {
          const index = qrLog.length - 1 - reverseIndex;
          const parsed = parseQRText(entry.text);
          const li = document.createElement("li");

          const textSpan = document.createElement("span");
          textSpan.className = "log-text";
          textSpan.innerHTML = formatText(entry.text, parsed.content, false);
          const buttonsDiv = document.createElement("div");
          buttonsDiv.className = "log-buttons";

          const upBtn = document.createElement("button");
          upBtn.className = "reorder-btn up-btn";
          upBtn.textContent = "â†‘";
          upBtn.disabled = reverseIndex === 0;
          upBtn.title = "Move up";

          const downBtn = document.createElement("button");
          downBtn.className = "reorder-btn down-btn";
          downBtn.textContent = "â†“";
          downBtn.disabled = reverseIndex === qrLog.length - 1;
          downBtn.title = "Move down";

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "Delete";
          deleteBtn.title = "Delete entry";

          upBtn.addEventListener("click", () => reorderLog(index, index + 1));
          downBtn.addEventListener("click", () => reorderLog(index, index - 1));
          deleteBtn.addEventListener("click", () => deleteLogEntry(index));

          buttonsDiv.appendChild(upBtn);
          buttonsDiv.appendChild(downBtn);
          buttonsDiv.appendChild(deleteBtn);

          li.appendChild(textSpan);
          li.appendChild(buttonsDiv);
          logList.appendChild(li);
        });

        const imageLinks = logList.querySelectorAll(".image-link");
        imageLinks.forEach(link => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const imageSrc = link.dataset.image;
            console.log(`Log image link clicked: ${imageSrc}`);
            showImagePopup(imageSrc);
          });
        });
      }

        function reorderLog(fromIndex, toIndex) {
          qrLog = JSON.parse(localStorage.getItem("qrLog") || "[]");
          if (toIndex >= 0 && toIndex < qrLog.length) {
            const [movedItem] = qrLog.splice(fromIndex, 1);
            qrLog.splice(toIndex, 0, movedItem);
            localStorage.setItem("qrLog", JSON.stringify(qrLog));
            console.log("Reordered qrLog:", qrLog);
            populateLog(qrLog);
          }
        }

        function deleteLogEntry(index) {
          qrLog = JSON.parse(localStorage.getItem("qrLog") || "[]");
          qrLog.splice(index, 1);
          localStorage.setItem("qrLog", JSON.stringify(qrLog));
          console.log("Deleted entry, new qrLog:", qrLog);
          populateLog(qrLog);
          viewLogButton.style.display = qrLog.length > 0 ? "block" : "none";
        }

        clearLogButton.addEventListener("click", () => {
          if (confirm("Are you sure you want to clear all QR codes from the log?")) {
            qrLog = [];
            localStorage.setItem("qrLog", JSON.stringify(qrLog));
            console.log("Cleared qrLog:", qrLog);
            populateLog(qrLog);
            viewLogButton.style.display = "none";
            logDiv.style.display = "none";
            document.getElementById("qr-log-backdrop").style.display = "none";  /* âœ… HIDE BACKDROP */
          }
        });

        viewLogButton.addEventListener("click", () => {
          qrLog = JSON.parse(localStorage.getItem("qrLog") || "[]");
          console.log("Opening log, qrLog:", qrLog);
          populateLog(qrLog);
          logDiv.style.display = "block";
          document.getElementById("qr-log-backdrop").style.display = "block";  /* âœ… SHOW BACKDROP */
        });

        closeLogButton.addEventListener("click", () => {
          logDiv.style.display = "none";
          document.getElementById("qr-log-backdrop").style.display = "none";   /* âœ… HIDE BACKDROP */
        });

        // âœ… FIXED homeButton click handler
        homeButton.addEventListener("click", () => {
          console.log("Home button clicked");
          closeImageAndConfettiPopups();
          resultDiv.innerHTML = "";  // âœ… FIX: Clear result div
          resultDiv.style.display = "none";  // âœ… FIX: Hide result div
        });

        slitScannerButton.addEventListener("click", () => switchView("slit-scanner"));
        magicLensButton.addEventListener("click", () => switchView("rgb-filter"));

        console.log("Starting initial view: scanner");
        html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", config);
        html5QrcodeScanner.render(onScanSuccess, onScanError, (cameraId) => {
          selectedCameraId = cameraId;
          console.log("Selected camera ID:", selectedCameraId);
          initializeTorchButton();
        });
        console.log("QR scanner initialized");

        const lockSketch = (p) => {
  let passcode = "1234";
  let successMessage = "Access Granted!";
  let enteredCode = ""; // Reset on initialization
  let statusMessage = ""; // Reset on initialization
  let indicatorColor = "#FFFFFF"; // Reset on initialization
  let scaleFactor;
  let canvasWidth, canvasHeight;
  let lastPressTime = 0;
  const debounceDelay = 200;

  p.setup = () => {
    console.log("Lock: setup");
    canvasWidth = Math.min(window.innerWidth, 400);
    canvasHeight = Math.min(window.innerHeight, 650);
    scaleFactor = canvasWidth / 400;
    p.createCanvas(canvasWidth, canvasHeight);
    p.textAlign(p.CENTER);
    p.textSize(32 * scaleFactor);
    // Reset state explicitly
    enteredCode = "";
    statusMessage = "";
    indicatorColor = "#FFFFFF";
    window.addEventListener('resize', () => {
      p.windowResized();
    });
  };

  p.draw = () => {
    p.background(220);
    p.fill(150);
    p.rect(50 * scaleFactor, 40 * scaleFactor, 300 * scaleFactor, 60 * scaleFactor, 10 * scaleFactor);
    p.fill(0);
    p.textSize(32 * scaleFactor);
    p.text(enteredCode, canvasWidth / 2, 80 * scaleFactor);
    p.fill(indicatorColor);
    p.text(statusMessage, canvasWidth / 2, 140 * scaleFactor);
    drawButton(100 * scaleFactor, 200 * scaleFactor, "1");
    drawButton(200 * scaleFactor, 200 * scaleFactor, "2");
    drawButton(300 * scaleFactor, 200 * scaleFactor, "3");
    drawButton(100 * scaleFactor, 300 * scaleFactor, "4");
    drawButton(200 * scaleFactor, 300 * scaleFactor, "5");
    drawButton(300 * scaleFactor, 300 * scaleFactor, "6");
    drawButton(100 * scaleFactor, 400 * scaleFactor, "7");
    drawButton(200 * scaleFactor, 400 * scaleFactor, "8");
    drawButton(300 * scaleFactor, 400 * scaleFactor, "9");
    drawButton(200 * scaleFactor, 500 * scaleFactor, "0");
    drawButton(canvasWidth - 100 * scaleFactor, canvasHeight - 80 * scaleFactor, "Enter", true);
    drawButton(100 * scaleFactor, canvasHeight - 80 * scaleFactor, "Clear", true);
  };

  function drawButton(x, y, label, isSpecial = false) {
    p.fill(200);
    if (isSpecial) {
      p.circle(x, y, 80 * scaleFactor);
    } else {
      p.rect(x - 40 * scaleFactor, y - 40 * scaleFactor, 80 * scaleFactor, 80 * scaleFactor, 10 * scaleFactor);
    }
    p.fill(0);
    p.textSize(isSpecial ? 24 * scaleFactor : 32 * scaleFactor);
    p.text(label, x, y + 10 * scaleFactor);
  }

  p.mousePressed = () => {
    const currentTime = p.millis();
    if (currentTime - lastPressTime < debounceDelay) {
      console.log("Debouncing: Ignoring rapid click");
      return;
    }
    lastPressTime = currentTime;

    checkButtonPress(100 * scaleFactor, 200 * scaleFactor, "1", false);
    checkButtonPress(200 * scaleFactor, 200 * scaleFactor, "2", false);
    checkButtonPress(300 * scaleFactor, 200 * scaleFactor, "3", false);
    checkButtonPress(100 * scaleFactor, 300 * scaleFactor, "4", false);
    checkButtonPress(200 * scaleFactor, 300 * scaleFactor, "5", false);
    checkButtonPress(300 * scaleFactor, 300 * scaleFactor, "6", false);
    checkButtonPress(100 * scaleFactor, 400 * scaleFactor, "7", false);
    checkButtonPress(200 * scaleFactor, 400 * scaleFactor, "8", false);
    checkButtonPress(300 * scaleFactor, 400 * scaleFactor, "9", false);
    checkButtonPress(200 * scaleFactor, 500 * scaleFactor, "0", false);
    if (p.dist(p.mouseX, p.mouseY, canvasWidth - 100 * scaleFactor, canvasHeight - 80 * scaleFactor) < 40 * scaleFactor) {
      verifyCode();
    }
    if (p.dist(p.mouseX, p.mouseY, 100 * scaleFactor, canvasHeight - 80 * scaleFactor) < 40 * scaleFactor) {
      enteredCode = "";
      statusMessage = "";
      indicatorColor = "#FFFFFF";
    }
  };

  function checkButtonPress(x, y, digit, isSpecial = false) {
    if (isSpecial) {
      if (p.dist(p.mouseX, p.mouseY, x, y) < 40 * scaleFactor) {
        enteredCode += digit;
      }
    } else {
      if (p.mouseX > x - 40 * scaleFactor && p.mouseX < x + 40 * scaleFactor &&
          p.mouseY > y - 40 * scaleFactor && p.mouseY < y + 40 * scaleFactor) {
        enteredCode += digit;
      }
    }
  }

  function verifyCode() {
    if (enteredCode === passcode) {
      statusMessage = successMessage;
      indicatorColor = "#00FF00";
      console.log("Correct passcode entered, closing lock pop-up and showing openlock.png");
      setTimeout(() => {
        lockPopup.style.display = "none";
        console.log("Lock pop-up hidden, style.display:", lockPopup.style.display);
        if (lockInstance) {
          try {
            lockInstance.noLoop();
            lockInstance.remove();
            lockInstance = null;
            console.log("Lock instance removed after success");
          } catch (err) {
            console.error("Error removing lock instance:", err);
          }
        }
        cleanUpCanvases();
        showImagePopup("img/openlock.png", true);
      }, 1000);
    } else {
      statusMessage = "Wrong";
      indicatorColor = "#FF0000";
      enteredCode = "";
      setTimeout(() => {
        statusMessage = "";
        indicatorColor = "#FFFFFF";
      }, 2000);
    }
  }

  p.windowResized = () => {
    console.log("Lock: windowResized");
    canvasWidth = Math.min(window.innerWidth, 400);
    canvasHeight = Math.min(window.innerHeight, 650);
    scaleFactor = canvasWidth / 400;
    p.resizeCanvas(canvasWidth, canvasHeight);
  };

  p.remove = () => {
    console.log("Lock: Removing sketch");
    p.noLoop();
    window.removeEventListener('resize', p.windowResized);
    p.remove();
  };
};

        const slitScannerSketch = (p) => {
          let video;
          let scan;
          let cameraInitialized = false;

          p.setup = () => {
            console.log("Slit Scanner: setup");
            const canvasWidth = window.innerWidth;
            const canvasHeight = document.documentElement.clientHeight - 50;
            p.createCanvas(canvasWidth, canvasHeight);
            p.pixelDensity(1);

            let constraints = {
              video: {
                facingMode: { exact: "environment" },
                width: { ideal: 1280, min: 640 },
                height: { ideal: 720, min: 480 }
              },
              audio: false
            };

            try {
              video = p.createCapture(constraints, function(stream) {
                if (stream && stream.active) {
                  console.log("Slit Scanner camera resolution:", video.width, "x", video.height);
                  cameraInitialized = true;
                } else {
                  console.error("Slit Scanner: Camera stream not active");
                  cameraInitialized = false;
                  let fallbackConstraints = {
                    video: { facingMode: { exact: "environment" } },
                    audio: false
                  };
                  video = p.createCapture(fallbackConstraints, function(fallbackStream) {
                    if (fallbackStream && fallbackStream.active) {
                      console.log("Slit Scanner fallback camera resolution:", video.width, "x", video.height);
                      cameraInitialized = true;
                    } else {
                      console.error("Slit Scanner: Fallback camera stream not active");
                      cameraInitialized = false;
                    }
                  });
                  video.hide();
                }
              });
              p.video = video;
              video.hide();
            } catch (err) {
              console.error("Slit Scanner: Error creating capture:", err);
              cameraInitialized = false;
            }

            scan = p.createGraphics(Math.floor(canvasWidth / 2), canvasHeight);
            scan.background(0);

            window.addEventListener('resize', () => {
              p.windowResized();
            });
          };

          p.draw = () => {
            p.background(0);

            if (!video || !video.loadedmetadata || !cameraInitialized) {
              p.fill(255);
              p.textSize(20);
              p.textAlign(p.CENTER);
              if (p.millis() > 15000) {
                p.text("Error: Camera failed to load. Please check permissions or refresh the page.", p.width / 2, p.height / 2, p.width - 40);
                if (video && !cameraInitialized) {
                  console.log("Slit Scanner: Attempting to restart video stream");
                  video.remove();
                  let constraints = {
                    video: { facingMode: { exact: "environment" } },
                    audio: false
                  };
                  video = p.createCapture(constraints, function(stream) {
                    if (stream && stream.active) {
                      console.log("Slit Scanner restart camera resolution:", video.width, "x", video.height);
                      cameraInitialized = true;
                    }
                  });
                  p.video = video;
                  video.hide();
                }
              } else {
                p.text("Loading camera...", p.width / 2, p.height / 2);
              }
              return;
            }

            p.image(video, 0, 0, p.width, p.height);
            let slitX = p.width / 2;
            p.stroke(255, 0, 0);
            p.strokeWeight(4);
            p.line(slitX, 0, slitX, p.height);
            scan.copy(scan, 0, 0, scan.width - 1, scan.height, 1, 0, scan.width - 1, scan.height);
            let scaleX = video.width / p.width;
            let sourceX = Math.floor(slitX * scaleX);
            if (sourceX >= 0 && sourceX < video.width) {
              scan.copy(video, sourceX, 0, 1, video.height, 0, 0, 1, scan.height);
            }
            p.image(scan, slitX, 0, p.width - slitX, p.height);
          };

          p.windowResized = () => {
            console.log("Slit Scanner: windowResized");
            const canvasWidth = window.innerWidth;
            const canvasHeight = document.documentElement.clientHeight - 50;
            p.resizeCanvas(canvasWidth, canvasHeight);
            scan = p.createGraphics(Math.floor(canvasWidth / 2), canvasHeight);
            scan.background(0);
          };

          p.remove = () => {
            console.log("Slit Scanner: Removing sketch");
            p.noLoop();
            if (p.video && p.video.elt.srcObject) {
              try {
                const stream = p.video.elt.srcObject;
                const tracks = stream.getTracks();
                tracks.forEach(track => {
                  track.stop();
                  console.log("Slit Scanner video track stopped:", track.label);
                });
                p.video.elt.srcObject = null;
                console.log("Slit Scanner video stream cleared");
              } catch (err) {
                console.error("Error stopping Slit Scanner video stream:", err);
              }
            }
            p.remove();
          };
        };

        const rgbFilterSketch = (p) => {
  let capture;
  let currentFilter = 'none';
  let redButton, greenButton, blueButton;
  let buttonSize = 50;
  let cameraInitialized = false;

  p.setup = () => {
    console.log("RGB Filter: setup");
    // Use clientWidth for accurate viewport width
    const canvasWidth = document.documentElement.clientWidth;
    const canvasHeight = document.documentElement.clientHeight - 50 - (parseInt(getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-top)') || 0) + parseInt(getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-bottom)') || 0));
    p.createCanvas(canvasWidth, canvasHeight);
    p.pixelDensity(p.displayDensity());
    p.canvas.style.display = 'block';
    p.canvas.style.margin = '0 auto'; // Center canvas in container

    let constraints = {
      video: {
        facingMode: { exact: "environment" },
        width: { ideal: 1280, min: 640 },
        height: { ideal: 720, min: 480 }
      },
      audio: false
    };

    try {
      capture = p.createCapture(constraints, function(stream) {
        if (stream && stream.active) {
          console.log("RGB Filter camera resolution:", capture.width, "x", capture.height);
          cameraInitialized = true;
        } else {
          console.error("RGB Filter: Camera stream not active");
          cameraInitialized = false;
          let fallbackConstraints = {
            video: { facingMode: { exact: "environment" } },
            audio: false
          };
          capture = p.createCapture(fallbackConstraints, function(fallbackStream) {
            if (fallbackStream && fallbackStream.active) {
              console.log("RGB Filter fallback camera resolution:", capture.width, "x", capture.height);
              cameraInitialized = true;
            } else {
              console.error("RGB Filter: Fallback camera stream not active");
              cameraInitialized = false;
            }
          });
          capture.hide();
        }
      });
      p.capture = capture;
      capture.hide();
    } catch (err) {
      console.error("RGB Filter: Error creating capture:", err);
      cameraInitialized = false;
    }

    // Create buttons and append to #rgb-button-container
    const buttonContainer = document.getElementById('rgb-button-container');
    if (!buttonContainer) {
      console.error("RGB button container not found");
      return;
    }

    redButton = p.createButton('');
    redButton.style('background', 'red');
    redButton.style('border-radius', '50%');
    redButton.style('width', `${buttonSize}px`);
    redButton.style('height', `${buttonSize}px`);
    redButton.style('border', 'none');
    redButton.mousePressed(() => currentFilter = 'red');
    p.redButton = redButton;
    buttonContainer.appendChild(redButton.elt);

    greenButton = p.createButton('');
    greenButton.style('background', 'green');
    greenButton.style('border-radius', '50%');
    greenButton.style('width', `${buttonSize}px`);
    greenButton.style('height', `${buttonSize}px`);
    greenButton.style('border', 'none');
    greenButton.mousePressed(() => currentFilter = 'green');
    p.greenButton = greenButton;
    buttonContainer.appendChild(greenButton.elt);

    blueButton = p.createButton('');
    blueButton.style('background', 'blue');
    blueButton.style('border-radius', '50%');
    blueButton.style('width', `${buttonSize}px`);
    blueButton.style('height', `${buttonSize}px`);
    blueButton.style('border', 'none');
    blueButton.mousePressed(() => currentFilter = 'blue');
    p.blueButton = blueButton;
    buttonContainer.appendChild(blueButton.elt);

    console.log("RGB Filter buttons appended to #rgb-button-container");

    // Debounce resize events
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        p.windowResized();
      }, 100); // Debounce by 100ms
    });
  };

  p.draw = () => {
    p.background(0);

    if (!capture || !capture.loadedmetadata || !cameraInitialized) {
      p.fill(255);
      p.textSize(20);
      p.textAlign(p.CENTER);
      if (p.millis() > 15000) {
        p.text("Error: Camera failed to load. Please check permissions or refresh the page.", p.width / 2, p.height / 2, p.width - 40);
        if (capture && !cameraInitialized) {
          console.log("RGB Filter: Attempting to restart video stream");
          capture.remove();
          let constraints = {
            video: { facingMode: { exact: "environment" } },
            audio: false
          };
          capture = p.createCapture(constraints, function(stream) {
            if (stream && stream.active) {
              console.log("RGB Filter restart camera resolution:", capture.width, "x", capture.height);
              cameraInitialized = true;
            }
          });
          p.capture = capture;
          capture.hide();
        }
      } else {
        p.text("Loading camera...", p.width / 2, p.height / 2);
      }
      return;
    }

    if (currentFilter === 'red') {
      p.tint(255, 0, 0);
    } else if (currentFilter === 'green') {
      p.tint(0, 255, 0);
    } else if (currentFilter === 'blue') {
      p.tint(0, 0, 255);
    } else {
      p.noTint();
    }

    p.image(capture, 0, 0, p.width, p.height);
  };

  p.windowResized = () => {
    console.log("RGB Filter: windowResized");
    const canvasWidth = document.documentElement.clientWidth;
    const canvasHeight = document.documentElement.clientHeight - 50 - (parseInt(getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-top)') || 0) + parseInt(getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-bottom)') || 0));
    p.resizeCanvas(canvasWidth, canvasHeight);
    console.log(`Canvas resized to ${canvasWidth}x${canvasHeight}`);
    // No need to reposition buttons; Flexbox handles centering
  };

  p.remove = () => {
    console.log("RGB Filter: Removing sketch");
    p.noLoop();
    if (p.capture && p.capture.elt.srcObject) {
      try {
        const stream = p.capture.elt.srcObject;
        const tracks = stream.getTracks();
        tracks.forEach(track => {
          track.stop();
          console.log("RGB Filter video track stopped:", track.label);
        });
        p.capture.elt.srcObject = null;
        console.log("RGB Filter video stream cleared");
      } catch (err) {
        console.error("Error stopping RGB Filter video stream:", err);
      }
    }
    if (p.redButton) p.redButton.remove();
    if (p.greenButton) p.greenButton.remove();
    if (p.blueButton) p.blueButton.remove();
    console.log("RGB Filter buttons removed");
    p.remove();
  };
};
      });
    </script>
  </body>
</html>
